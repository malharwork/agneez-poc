<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Learning Assistant - Enhanced with Progress Tracking</title>
    <style>
        :root {
            --primary-color: #5e72e4;
            --secondary-color: #2dce89;
            --warning-color: #fb6340;
            --info-color: #11cdef;
            --dark: #32325d;
            --light: #f7f8fc;
            --text-primary: #32325d;
            --text-secondary: #8898aa;
            --border-color: #dee2e6;
            --success-color: #2dce89;
            --danger-color: #f5365c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--light) 0%, #e9ecef 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.8s ease-out;
        }

        header h1 {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--info-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            gap: 1.5rem;
            animation: slideUp 0.8s ease-out;
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .progress-panel {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .sidebar::-webkit-scrollbar,
        .progress-panel::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track,
        .progress-panel::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb,
        .progress-panel::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .topic-selector {
            margin-bottom: 1.5rem;
        }

        .topic-card {
            background: var(--light);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .topic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .topic-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(94,114,228,0.1), rgba(17,205,239,0.1));
        }

        .topic-card h3 {
            color: var(--dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .topic-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .math-icon {
            background: linear-gradient(135deg, var(--primary-color), var(--info-color));
            color: white;
        }

        .bio-icon {
            background: linear-gradient(135deg, var(--secondary-color), #20c997);
            color: white;
        }

        .mastery-indicator {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .mastery-low { background: #ffeaa7; color: #d63031; }
        .mastery-medium { background: #fdcb6e; color: #e17055; }
        .mastery-high { background: #00b894; color: white; }

        .academic-selector {
            background: var(--light);
            padding: 1.2rem;
            border-radius: 10px;
            margin-bottom: 1.2rem;
        }

        .academic-selector h3 {
            margin-bottom: 1rem;
            color: var(--dark);
            font-size: 1rem;
        }

        .selector-group {
            margin-bottom: 0.8rem;
        }

        .selector-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .selector-group select {
            width: 100%;
            padding: 0.5rem 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .selector-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .subtopic-selector {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
        }

        .subtopic-selector h3 {
            margin-bottom: 0.8rem;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .subtopic-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .subtopic-btn {
            padding: 0.4rem 0.8rem;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .subtopic-btn:hover {
            border-color: var(--info-color);
            background: rgba(17, 205, 239, 0.1);
        }

        .subtopic-btn.selected {
            background: var(--info-color);
            color: white;
            border-color: var(--info-color);
        }

        .progress-summary {
            margin-bottom: 1.5rem;
        }

        .progress-card {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }

        .progress-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .progress-stat:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .stat-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .topic-progress {
            margin-bottom: 1.5rem;
        }

        .topic-progress-item {
            background: white;
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .topic-name {
            font-weight: 500;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--light);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--info-color));
            transition: width 0.3s ease;
        }

        .recommendations {
            margin-bottom: 1.5rem;
        }

        .recommendation-item {
            background: rgba(94, 114, 228, 0.05);
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--primary-color);
        }

        .recommendation-item.high-priority {
            border-left-color: var(--danger-color);
            background: rgba(245, 54, 92, 0.05);
        }

        .recommendation-item.medium-priority {
            border-left-color: var(--warning-color);
            background: rgba(251, 99, 64, 0.05);
        }

        .rec-title {
            font-weight: 500;
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
        }

        .rec-description {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .chat-area {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
        }

        .chat-header {
            padding: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--light), white);
            border-radius: 15px 15px 0 0;
            position: relative;
        }

        .current-context {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .context-badge {
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .topic-badge { background: var(--primary-color); color: white; }
        .grade-badge { background: var(--secondary-color); color: white; }
        .board-badge { background: var(--warning-color); color: white; }
        .subtopic-badge { background: var(--info-color); color: white; }

        .session-info {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.8rem;
        }

        .session-timer {
            color: var(--primary-color);
            font-weight: 500;
        }

        .mastery-display {
            color: var(--secondary-color);
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 1.2rem;
            animation: fadeIn 0.5s ease-out;
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 1rem 1.2rem;
            border-radius: 15px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: var(--primary-color);
            color: white;
            border-radius: 15px 15px 0 15px;
        }

        .message.assistant .message-content {
            background: var(--light);
            color: var(--text-primary);
            border-radius: 15px 15px 15px 0;
        }

        .message-meta {
            margin-top: 0.4rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .content-info {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.3rem;
        }

        .content-tag {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            background: var(--info-color);
            color: white;
            border-radius: 8px;
            font-size: 0.65rem;
        }

        .interaction-feedback {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .feedback-btn {
            padding: 0.3rem 0.6rem;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .feedback-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .feedback-btn.success {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .feedback-btn.error {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .chat-input-area {
            padding: 1.2rem;
            border-top: 1px solid var(--border-color);
            background: var(--light);
            border-radius: 0 0 15px 15px;
        }

        .chat-controls {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 0.4rem 0.8rem;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .control-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .chat-form {
            display: flex;
            gap: 0.8rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.7rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .send-btn {
            padding: 0.7rem 1.2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .send-btn:hover {
            background: #4c63d2;
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 1.5rem;
        }

        .loading.active {
            display: block;
        }

        .loading-spinner {
            width: 35px;
            height: 35px;
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .analytics-toggle {
            margin-bottom: 1rem;
        }

        .toggle-btn {
            width: 100%;
            padding: 0.6rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .toggle-btn:hover {
            background: #4c63d2;
        }

        .analytics-panel {
            display: none;
            margin-top: 1rem;
        }

        .analytics-panel.active {
            display: block;
        }

        .chart-container {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 300px 1fr;
            }
            
            .progress-panel {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                max-height: none;
                margin-bottom: 1rem;
            }
            
            .chat-area {
                height: 500px;
            }
            
            .container {
                padding: 1rem;
            }
            
            .message-content {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéì Adaptive Learning Assistant</h1>
            <p>Enhanced with AI-powered progress tracking and personalized learning paths</p>
        </header>

        <div class="main-content">
            <!-- Left Sidebar -->
            <div class="sidebar">
                <div class="topic-selector">
                    <h3>Choose a Topic</h3>
                    <div class="topic-card" data-topic="quadratic_equations" data-index="math_index" data-namespace="algebra_quadratic_equations">
                        <div class="mastery-indicator mastery-low" id="quad-mastery">0%</div>
                        <h3>
                            <span class="topic-icon math-icon">‚àë</span>
                            Quadratic Equations
                        </h3>
                        <p>Master quadratic equations with adaptive learning</p>
                    </div>
                    <div class="topic-card" data-topic="digestive_system" data-index="science_index" data-namespace="biology_digestive_system">
                        <div class="mastery-indicator mastery-low" id="digest-mastery">0%</div>
                        <h3>
                            <span class="topic-icon bio-icon">üß¨</span>
                            Digestive System
                        </h3>
                        <p>Explore human digestion with grade-appropriate content</p>
                    </div>
                </div>

                <div class="academic-selector" style="display: none;">
                    <h3>Academic Profile</h3>
                    <div class="selector-group">
                        <label for="board-select">Board</label>
                        <select id="board-select">
                            <option value="">Select Board</option>
                            <option value="CBSE">CBSE (Central Board)</option>
                            <option value="ICSE">ICSE (CISCE Board)</option>
                            <option value="SSC">SSC (Maharashtra Board)</option>
                        </select>
                    </div>
                    
                    <div class="selector-group">
                        <label for="grade-select">Grade</label>
                        <select id="grade-select">
                            <option value="">Select Grade</option>
                            <option value="3">Grade 3</option>
                            <option value="4">Grade 4</option>
                            <option value="5">Grade 5</option>
                            <option value="6">Grade 6</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                            <option value="10">Grade 10</option>
                            <option value="11">Grade 11</option>
                            <option value="12">Grade 12</option>
                        </select>
                    </div>
                    
                    <div class="selector-group">
                        <label for="language-select">Language</label>
                        <select id="language-select">
                            <option value="english">English</option>
                            <option value="hindi">Hindi</option>
                            <option value="marathi">Marathi (SSC)</option>
                        </select>
                    </div>
                </div>

                <div class="subtopic-selector" style="display: none;">
                    <h3>Focus Area</h3>
                    <div class="subtopic-options" id="subtopic-options">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <button class="control-btn" id="learning-path-btn" style="width: 100%; margin-top: 1rem; display: none;">
                    üìö View Learning Path
                </button>
            </div>

            <!-- Main Chat Area -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="current-context">
                        <span>Current Context:</span>
                        <span class="context-badge topic-badge" id="selected-topic">No topic selected</span>
                        <span class="context-badge grade-badge" id="selected-grade" style="display: none;">Grade -</span>
                        <span class="context-badge board-badge" id="selected-board" style="display: none;">Board -</span>
                        <span class="context-badge subtopic-badge" id="selected-subtopic" style="display: none;">All subtopics</span>
                    </div>
                    
                    <div class="session-info" id="session-info" style="display: none;">
                        <div class="session-timer" id="session-timer">00:00</div>
                        <div class="mastery-display" id="mastery-display">Mastery: 0%</div>
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="message assistant">
                        <div class="message-content">
                            üëã Welcome to the Enhanced Adaptive Learning System! 
                            <br><br>
                            üéØ <strong>New Features:</strong><br>
                            ‚Ä¢ Real-time progress tracking<br>
                            ‚Ä¢ Personalized learning recommendations<br>
                            ‚Ä¢ Adaptive content based on your performance<br>
                            ‚Ä¢ Detailed analytics and insights<br>
                            <br>
                            Select a topic and configure your academic details to get started with your personalized learning journey!
                        </div>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>Processing your request...</p>
                </div>

                <div class="chat-input-area">
                    <div class="chat-controls">
                        <button class="control-btn" id="adaptive-mode-btn">üéØ Adaptive Mode</button>
                        <button class="control-btn" id="practice-mode-btn">‚úèÔ∏è Practice Mode</button>
                        <button class="control-btn" id="review-mode-btn">üìñ Review Mode</button>
                        <button class="control-btn" id="progress-btn">üìä View Progress</button>
                    </div>
                    
                    <form class="chat-form" id="chat-form">
                        <input 
                            type="text" 
                            class="chat-input" 
                            id="user-input" 
                            placeholder="Ask a question or type 'help' for guidance..."
                            disabled
                        >
                        <button type="submit" class="send-btn" disabled>
                            Send
                            <span>‚Üí</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Progress Panel -->
            <div class="progress-panel">
                <div class="progress-summary">
                    <h3>üìä Your Progress</h3>
                    <div class="progress-card">
                        <div class="progress-stat">
                            <span class="stat-label">Questions Answered</span>
                            <span class="stat-value" id="total-questions">0</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-label">Overall Accuracy</span>
                            <span class="stat-value" id="overall-accuracy">0%</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-label">Study Time</span>
                            <span class="stat-value" id="study-time">0h</span>
                        </div>
                        <div class="progress-stat">
                            <span class="stat-label">Topics Attempted</span>
                            <span class="stat-value" id="topics-attempted">0</span>
                        </div>
                    </div>
                </div>

                <div class="topic-progress">
                    <h3>üìà Topic Mastery</h3>
                    <div id="topic-progress-list">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <div class="recommendations">
                    <h3>üí° Recommendations</h3>
                    <div id="recommendations-list">
                        <div class="recommendation-item">
                            <div class="rec-title">Get Started</div>
                            <div class="rec-description">Select a topic and start learning to see personalized recommendations!</div>
                        </div>
                    </div>
                </div>

                <div class="analytics-toggle">
                    <button class="toggle-btn" id="analytics-toggle">View Detailed Analytics</button>
                    <div class="analytics-panel" id="analytics-panel">
                        <!-- Analytics content will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced state management with progress tracking
        let currentState = {
            topic: null,
            index: null,
            namespace: null,
            grade: null,
            board: null,
            language: 'english',
            subtopic: null,
            methodPreference: null,
            excludeMethods: [],
            mode: 'normal',
            sessionId: null,
            sessionStartTime: null,
            performance: {
                mastery: 0,
                questionsAnswered: 0,
                correctAnswers: 0
            }
        };

        // Progress tracking variables
        let progressData = {
            student_info: {},
            overall_stats: {},
            topic_progress: {},
            recent_activity: [],
            learning_recommendations: {}
        };

        // Session timer
        let sessionTimer = null;

        // Subtopic configurations (same as before)
        const subtopicConfig = {
            'quadratic_equations': {
                'patterns_introduction': {
                    name: 'Patterns & Square Numbers',
                    methods: ['visual_patterns', 'number_sequences']
                },
                'factorization_method': {
                    name: 'Factorization Methods',
                    methods: ['simple_factoring', 'splitting_middle_term', 'grouping']
                },
                'formula_method': {
                    name: 'Quadratic Formula',
                    methods: ['derivation', 'application', 'discriminant_analysis']
                },
                'completing_square': {
                    name: 'Completing the Square',
                    methods: ['geometric_interpretation', 'algebraic_method']
                },
                'applications': {
                    name: 'Real-world Applications',
                    methods: ['physics_problems', 'optimization', 'geometry']
                }
            },
            'digestive_system': {
                'anatomy_structure': {
                    name: 'Anatomical Structure',
                    methods: ['organs', 'tissues', 'cellular_structure']
                },
                'digestion_process': {
                    name: 'Digestion Process',
                    methods: ['mechanical_digestion', 'chemical_digestion', 'peristalsis']
                },
                'enzymes_secretions': {
                    name: 'Enzymes & Secretions',
                    methods: ['digestive_enzymes', 'hormonal_control', 'pH_regulation']
                },
                'absorption_transport': {
                    name: 'Absorption & Transport',
                    methods: ['villi_function', 'nutrient_transport', 'water_absorption']
                },
                'disorders_health': {
                    name: 'Health & Disorders',
                    methods: ['common_disorders', 'prevention', 'dietary_management']
                }
            }
        };

        // DOM elements
        const topicCards = document.querySelectorAll('.topic-card');
        const academicSelector = document.querySelector('.academic-selector');
        const boardSelect = document.getElementById('board-select');
        const gradeSelect = document.getElementById('grade-select');
        const languageSelect = document.getElementById('language-select');
        const subtopicSelector = document.querySelector('.subtopic-selector');
        const subtopicOptions = document.getElementById('subtopic-options');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.querySelector('.send-btn');
        const chatMessages = document.getElementById('chat-messages');
        const loading = document.getElementById('loading');
        const learningPathBtn = document.getElementById('learning-path-btn');
        
        // Context badges
        const selectedTopicBadge = document.getElementById('selected-topic');
        const selectedGradeBadge = document.getElementById('selected-grade');
        const selectedBoardBadge = document.getElementById('selected-board');
        const selectedSubtopicBadge = document.getElementById('selected-subtopic');
        
        // Progress elements
        const sessionInfo = document.getElementById('session-info');
        const sessionTimerEl = document.getElementById('session-timer');
        const masteryDisplayEl = document.getElementById('mastery-display');
        const totalQuestionsEl = document.getElementById('total-questions');
        const overallAccuracyEl = document.getElementById('overall-accuracy');
        const studyTimeEl = document.getElementById('study-time');
        const topicsAttemptedEl = document.getElementById('topics-attempted');
        const topicProgressList = document.getElementById('topic-progress-list');
        const recommendationsList = document.getElementById('recommendations-list');
        
        // Mode buttons
        const adaptiveModeBtn = document.getElementById('adaptive-mode-btn');
        const practiceModeBtn = document.getElementById('practice-mode-btn');
        const reviewModeBtn = document.getElementById('review-mode-btn');
        const progressBtn = document.getElementById('progress-btn');
        const analyticsToggle = document.getElementById('analytics-toggle');
        const analyticsPanel = document.getElementById('analytics-panel');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadProgressData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Topic selection
            topicCards.forEach(card => {
                card.addEventListener('click', function() {
                    selectTopic(this);
                });
            });

            // Academic selectors
            boardSelect.addEventListener('change', updateBoard);
            gradeSelect.addEventListener('change', updateGrade);
            languageSelect.addEventListener('change', updateLanguage);

            // Mode buttons
            adaptiveModeBtn.addEventListener('click', () => setMode('adaptive'));
            practiceModeBtn.addEventListener('click', () => setMode('practice'));
            reviewModeBtn.addEventListener('click', () => setMode('review'));
            progressBtn.addEventListener('click', showDetailedProgress);

            // Chat form
            chatForm.addEventListener('submit', handleChatSubmit);
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.dispatchEvent(new Event('submit'));
                }
            });

            // Learning path button
            learningPathBtn.addEventListener('click', showLearningPath);

            // Analytics toggle
            analyticsToggle.addEventListener('click', toggleAnalytics);
        }

        function selectTopic(card) {
            topicCards.forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            
            currentState.topic = card.dataset.topic;
            currentState.index = card.dataset.index;
            currentState.namespace = card.dataset.namespace;
            
            const topicName = card.querySelector('h3').textContent.trim();
            selectedTopicBadge.textContent = topicName;
            
            populateSubtopics(currentState.topic);
            academicSelector.style.display = 'block';
            subtopicSelector.style.display = 'block';
            
            updateTopicMastery();
            resetSelections();
        }

        function updateBoard() {
            currentState.board = boardSelect.value;
            if (currentState.board) {
                selectedBoardBadge.textContent = currentState.board;
                selectedBoardBadge.style.display = 'inline-block';
                
                // Update language options based on board
                if (currentState.board === 'SSC') {
                    languageSelect.querySelector('option[value="marathi"]').style.display = 'block';
                } else {
                    languageSelect.querySelector('option[value="marathi"]').style.display = 'none';
                    if (currentState.language === 'marathi') {
                        languageSelect.value = 'english';
                        currentState.language = 'english';
                    }
                }
                
                updateStudentProfile();
                checkReadiness();
            }
        }

        function updateGrade() {
            currentState.grade = parseInt(gradeSelect.value);
            if (currentState.grade) {
                selectedGradeBadge.textContent = `Grade ${currentState.grade}`;
                selectedGradeBadge.style.display = 'inline-block';
                
                updateStudentProfile();
                checkReadiness();
            }
        }

        function updateLanguage() {
            currentState.language = languageSelect.value;
            updateStudentProfile();
        }

        function updateStudentProfile() {
            if (currentState.grade && currentState.board) {
                fetch('/api/student/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        grade: currentState.grade,
                        board: currentState.board,
                        language: currentState.language
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Profile updated:', data);
                    loadProgressData();
                })
                .catch(console.error);
            }
        }

        function populateSubtopics(topic) {
            subtopicOptions.innerHTML = '';
            const subtopics = subtopicConfig[topic] || {};
            
            Object.entries(subtopics).forEach(([key, config]) => {
                const btn = document.createElement('button');
                btn.className = 'subtopic-btn';
                btn.dataset.subtopic = key;
                btn.textContent = config.name;
                btn.addEventListener('click', selectSubtopic);
                subtopicOptions.appendChild(btn);
            });
        }

        function selectSubtopic(e) {
            const btn = e.target;
            const subtopic = btn.dataset.subtopic;
            
            if (btn.classList.contains('selected')) {
                btn.classList.remove('selected');
                currentState.subtopic = null;
                selectedSubtopicBadge.style.display = 'none';
            } else {
                document.querySelectorAll('.subtopic-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                currentState.subtopic = subtopic;
                selectedSubtopicBadge.textContent = btn.textContent;
                selectedSubtopicBadge.style.display = 'inline-block';
            }
        }

        function setMode(mode) {
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            
            currentState.mode = mode;
            
            if (mode === 'adaptive') {
                adaptiveModeBtn.classList.add('active');
                startLearningSession();
            } else if (mode === 'practice') {
                practiceModeBtn.classList.add('active');
            } else if (mode === 'review') {
                reviewModeBtn.classList.add('active');
            }
            
            updateChatPlaceholder();
        }

        function startLearningSession() {
            fetch('/api/session/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                currentState.sessionId = data.session_id;
                currentState.sessionStartTime = Date.now();
                sessionInfo.style.display = 'flex';
                startSessionTimer();
            })
            .catch(console.error);
        }

        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - currentState.sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                sessionTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function endLearningSession() {
            if (currentState.sessionId) {
                fetch('/api/session/end', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topics_covered: currentState.topic ? [currentState.topic] : []
                    })
                })
                .then(() => {
                    currentState.sessionId = null;
                    currentState.sessionStartTime = null;
                    sessionInfo.style.display = 'none';
                    if (sessionTimer) {
                        clearInterval(sessionTimer);
                        sessionTimer = null;
                    }
                })
                .catch(console.error);
            }
        }

        function loadProgressData() {
            fetch('/api/student/progress')
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        progressData = data;
                        updateProgressDisplay();
                        updateTopicMastery();
                    }
                })
                .catch(console.error);
        }

        function updateProgressDisplay() {
            if (progressData.overall_stats) {
                totalQuestionsEl.textContent = progressData.overall_stats.total_questions || 0;
                overallAccuracyEl.textContent = progressData.overall_stats.overall_accuracy || '0%';
                studyTimeEl.textContent = progressData.overall_stats.total_time_hours || '0h';
                topicsAttemptedEl.textContent = progressData.overall_stats.topics_attempted || 0;
            }

            // Update topic progress list
            if (progressData.topic_progress) {
                topicProgressList.innerHTML = '';
                Object.entries(progressData.topic_progress).forEach(([topic, data]) => {
                    const item = document.createElement('div');
                    item.className = 'topic-progress-item';
                    item.innerHTML = `
                        <div class="topic-name">${topic.replace('_', ' ').toUpperCase()}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(data.mastery_level * 100)}%"></div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.2rem;">
                            ${(data.mastery_level * 100).toFixed(1)}% mastery ‚Ä¢ ${data.total_attempts} attempts
                        </div>
                    `;
                    topicProgressList.appendChild(item);
                });
            }

            // Update recommendations
            if (progressData.learning_recommendations && progressData.learning_recommendations.priority_actions) {
                recommendationsList.innerHTML = '';
                progressData.learning_recommendations.priority_actions.forEach(rec => {
                    const item = document.createElement('div');
                    item.className = `recommendation-item ${rec.urgency}-priority`;
                    item.innerHTML = `
                        <div class="rec-title">${rec.action.replace('_', ' ').toUpperCase()}</div>
                        <div class="rec-description">${rec.description}</div>
                    `;
                    recommendationsList.appendChild(item);
                });
            }

            // Update mastery display in session info
            if (currentState.topic && progressData.topic_progress[currentState.topic]) {
                const mastery = (progressData.topic_progress[currentState.topic].mastery_level * 100).toFixed(1);
                masteryDisplayEl.textContent = `Mastery: ${mastery}%`;
            }
        }

        function updateTopicMastery() {
            if (progressData.topic_progress) {
                // Update quadratic equations mastery
                const quadMastery = progressData.topic_progress.quadratic_equations;
                if (quadMastery) {
                    const quadMasteryEl = document.getElementById('quad-mastery');
                    const masteryPercent = (quadMastery.mastery_level * 100).toFixed(0);
                    quadMasteryEl.textContent = `${masteryPercent}%`;
                    
                    if (masteryPercent < 60) {
                        quadMasteryEl.className = 'mastery-indicator mastery-low';
                    } else if (masteryPercent < 80) {
                        quadMasteryEl.className = 'mastery-indicator mastery-medium';
                    } else {
                        quadMasteryEl.className = 'mastery-indicator mastery-high';
                    }
                }

                // Update digestive system mastery
                const digestMastery = progressData.topic_progress.digestive_system;
                if (digestMastery) {
                    const digestMasteryEl = document.getElementById('digest-mastery');
                    const masteryPercent = (digestMastery.mastery_level * 100).toFixed(0);
                    digestMasteryEl.textContent = `${masteryPercent}%`;
                    
                    if (masteryPercent < 60) {
                        digestMasteryEl.className = 'mastery-indicator mastery-low';
                    } else if (masteryPercent < 80) {
                        digestMasteryEl.className = 'mastery-indicator mastery-medium';
                    } else {
                        digestMasteryEl.className = 'mastery-indicator mastery-high';
                    }
                }
            }
        }

        function checkReadiness() {
            if (currentState.topic && currentState.board && currentState.grade) {
                userInput.disabled = false;
                sendBtn.disabled = false;
                learningPathBtn.style.display = 'block';
                updateChatPlaceholder();
                
                const welcomeMsg = `Ready to learn ${currentState.topic.replace('_', ' ')} for Grade ${currentState.grade} ${currentState.board} board! üöÄ`;
                addMessage('assistant', welcomeMsg);
            }
        }

        function updateChatPlaceholder() {
            let placeholder = `Ask about ${currentState.topic?.replace('_', ' ') || 'your topic'}`;
            
            if (currentState.mode === 'adaptive') {
                placeholder = "üéØ Adaptive mode: I'll adjust to your level. Ask anything!";
            } else if (currentState.mode === 'practice') {
                placeholder = "‚úèÔ∏è Practice mode: Ask for problems or exercises...";
            } else if (currentState.mode === 'review') {
                placeholder = "üìñ Review mode: What would you like to review?";
            }
            
            userInput.placeholder = placeholder;
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            
            const message = userInput.value.trim();
            if (!message || !currentState.topic || !currentState.board || !currentState.grade) return;
            
            addMessage('user', message);
            userInput.value = '';
            loading.classList.add('active');
            
            try {
                let endpoint = '/api/chat';
                const requestBody = {
                    message: message,
                    topic: currentState.topic,
                    grade: currentState.grade,
                    board: currentState.board,
                    language: currentState.language
                };
                
                if (currentState.subtopic) {
                    requestBody.subtopic = currentState.subtopic;
                }
                
                if (currentState.methodPreference) {
                    requestBody.method_preference = currentState.methodPreference;
                }
                
                if (currentState.excludeMethods.length > 0) {
                    requestBody.exclude_methods = currentState.excludeMethods;
                }
                
                const isAdaptiveRequest = (
                    currentState.mode === 'adaptive' && 
                    (message.toLowerCase().includes('adaptive') || 
                     message.toLowerCase().includes('recommend content') || 
                     message.toLowerCase().includes('suggest content'))
                );
                
                if (isAdaptiveRequest) {
                    endpoint = '/api/adaptive-content';
                    requestBody.performance = currentState.performance.mastery;
                    delete requestBody.message;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    addMessage('assistant', `I encountered an error: ${data.error}`);
                } else {
                    currentState.performance.questionsAnswered++;
                    
                    if (endpoint === '/api/adaptive-content') {
                        if (data.adaptive_content && data.adaptive_content.length > 0) {
                            addMessage('assistant', data.adaptive_content, null, true);
                        } else {
                            addMessage('assistant', 'No adaptive content found. Let me provide a general explanation.');
                        }
                    } else {
                        if (data.answer) {
                            const messageId = addMessage('assistant', data.answer, data.content_metadata);
                            
                            // Add interaction feedback for progress tracking
                            if (data.content_metadata && data.content_metadata.length > 0) {
                                addInteractionFeedback(messageId, data.content_metadata[0]);
                            }
                        }
                    }
                    
                    // Update progress display
                    if (data.student_mastery) {
                        masteryDisplayEl.textContent = `Mastery: ${data.student_mastery}`;
                    }
                }
            } catch (error) {
                addMessage('assistant', `I encountered an error: ${error.message}. Please try again.`);
            } finally {
                loading.classList.remove('active');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Refresh progress data after interaction
                setTimeout(loadProgressData, 1000);
            }
        }

        function addMessage(role, content, metadata = null, isAdaptiveContent = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role);
            const messageId = 'msg_' + Date.now();
            messageDiv.id = messageId;
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            
            if (isAdaptiveContent && Array.isArray(content)) {
                contentDiv.innerHTML = formatAdaptiveContent(content);
            } else if (typeof content === 'string') {
                contentDiv.innerHTML = formatMessageContent(content);
            }
            
            messageDiv.appendChild(contentDiv);
            
            // Add metadata if available
            if (metadata && Array.isArray(metadata) && metadata.length > 0) {
                const metaDiv = document.createElement('div');
                metaDiv.classList.add('message-meta');
                
                const infoDiv = document.createElement('div');
                infoDiv.classList.add('content-info');
                
                metadata.forEach(meta => {
                    if (meta.content_type) {
                        const tag = document.createElement('span');
                        tag.classList.add('content-tag');
                        tag.textContent = meta.content_type.replace(/_/g, ' ');
                        infoDiv.appendChild(tag);
                    }
                    if (meta.difficulty_level) {
                        const tag = document.createElement('span');
                        tag.classList.add('content-tag');
                        tag.style.background = 'var(--warning-color)';
                        tag.textContent = `Level ${meta.difficulty_level}`;
                        infoDiv.appendChild(tag);
                    }
                    if (meta.subtopic) {
                        const tag = document.createElement('span');
                        tag.classList.add('content-tag');
                        tag.style.background = 'var(--info-color)';
                        tag.textContent = meta.subtopic.replace(/_/g, ' ');
                        infoDiv.appendChild(tag);
                    }
                });
                
                if (infoDiv.children.length > 0) {
                    metaDiv.appendChild(infoDiv);
                    messageDiv.appendChild(metaDiv);
                }
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageId;
        }

        function addInteractionFeedback(messageId, metadata) {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;
            
            const feedbackDiv = document.createElement('div');
            feedbackDiv.classList.add('interaction-feedback');
            feedbackDiv.innerHTML = `
                <span style="font-size: 0.7rem; color: var(--text-secondary);">Was this helpful?</span>
                <button class="feedback-btn" onclick="recordInteraction('${metadata.content_id}', true, '${currentState.topic}', '${metadata.subtopic || ''}')">üëç Yes</button>
                <button class="feedback-btn" onclick="recordInteraction('${metadata.content_id}', false, '${currentState.topic}', '${metadata.subtopic || ''}')">üëé No</button>
            `;
            
            messageDiv.appendChild(feedbackDiv);
        }

        function recordInteraction(contentId, success, topic, subtopic) {
            fetch('/api/interaction/record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content_id: contentId,
                    topic: topic,
                    subtopic: subtopic,
                    success: success,
                    time_taken: Math.floor(Math.random() * 60) + 30, // Simulate time
                    difficulty_level: 3,
                    question_text: userInput.value || 'General question',
                    user_answer: success ? 'Understood' : 'Confused'
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Interaction recorded:', data);
                
                // Update feedback buttons
                event.target.classList.add(success ? 'success' : 'error');
                const feedbackDiv = event.target.parentElement;
                feedbackDiv.querySelectorAll('.feedback-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                });
                
                // Refresh progress data
                setTimeout(loadProgressData, 500);
            })
            .catch(console.error);
        }

        function formatMessageContent(content) {
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
            content = content.replace(/\n/g, '<br>');
            content = content.replace(/(\d+)\.\s+(.+?)(?=<br>|$)/g, '<br>$1. $2');
            content = content.replace(/^[\-‚Ä¢]\s+(.+?)(?=<br>|$)/gm, '<br>‚Ä¢ $1');
            return content;
        }

        function formatAdaptiveContent(contentArray) {
            let html = '<strong>üìö Adaptive Content Recommendations:</strong><br><br>';
            
            contentArray.forEach((item, index) => {
                html += `<div style="margin-bottom: 1rem; padding: 1rem; background: rgba(94, 114, 228, 0.05); border-left: 4px solid var(--primary-color); border-radius: 8px;">`;
                html += `<strong>${index + 1}. ${item.content_type?.replace(/_/g, ' ') || 'Learning Content'}</strong>`;
                
                if (item.subtopic) {
                    html += ` <span style="color: var(--info-color); font-size: 0.9em;">(${item.subtopic.replace(/_/g, ' ')})</span>`;
                }
                
                html += `<br>`;
                html += `<div style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.5rem 0;">`;
                html += `üìä Difficulty: Level ${item.difficulty_level || 'N/A'} | `;
                html += `‚è±Ô∏è Time: ${item.estimated_time_minutes || '15'} mins | `;
                html += `üéØ Board: ${item.board || 'General'}`;
                html += `</div>`;
                
                if (item.text) {
                    const preview = item.text.length > 300 ? item.text.substring(0, 300) + '...' : item.text;
                    html += `<div style="margin-top: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; font-size: 0.9rem;">`;
                    html += formatMessageContent(preview);
                    html += `</div>`;
                }
                
                if (item.method_tags && item.method_tags.length > 0) {
                    html += `<div style="margin-top: 0.5rem;">`;
                    html += `<small style="color: var(--text-secondary);">Methods: ${item.method_tags.join(', ')}</small>`;
                    html += `</div>`;
                }
                
                html += `</div>`;
            });
            
            html += `<br><em style="color: var(--text-secondary); font-size: 0.9rem;">üí° These recommendations are tailored to your current performance level.</em>`;
            
            return html;
        }

        async function showLearningPath() {
            if (!currentState.topic || !currentState.board || !currentState.grade) return;
            
            loading.classList.add('active');
            
            try {
                const response = await fetch('/api/learning-path', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: currentState.topic,
                        grade: currentState.grade,
                        board: currentState.board,
                        current_subtopic: currentState.subtopic,
                        mastery_level: currentState.performance.mastery
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    addMessage('assistant', `Error: ${data.error}`);
                } else {
                    const pathMessage = formatLearningPath(data);
                    addMessage('assistant', pathMessage);
                }
            } catch (error) {
                addMessage('assistant', `Error: ${error.message}`);
            } finally {
                loading.classList.remove('active');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function formatLearningPath(data) {
            let content = `<strong>üìö Your Personalized Learning Path</strong><br><br>`;
            
            content += `<strong>Current Status:</strong><br>`;
            content += `‚Ä¢ Topic: ${data.current_subtopic || 'Starting'}<br>`;
            content += `‚Ä¢ Grade: ${data.current_grade}<br>`;
            content += `‚Ä¢ Board: ${data.board}<br>`;
            content += `‚Ä¢ Database Mastery: ${(data.database_mastery * 100).toFixed(0)}%<br>`;
            content += `‚Ä¢ Effective Mastery: ${(data.effective_mastery * 100).toFixed(0)}%<br><br>`;
            
            content += `<strong>Recommendation:</strong> ${data.recommendation}<br><br>`;
            
            if (data.next_steps && data.next_steps.length > 0) {
                content += `<strong>Next Steps:</strong><br>`;
                data.next_steps.forEach(step => {
                    content += `‚Ä¢ Focus on: ${step.subtopic} (${step.focus})<br>`;
                    if (step.prerequisites_to_review && step.prerequisites_to_review.length > 0) {
                        content += `  Review: ${step.prerequisites_to_review.join(', ')}<br>`;
                    }
                });
            }
            
            if (data.personalized_recommendations && data.personalized_recommendations.priority_actions) {
                content += `<br><strong>üìà Personalized Recommendations:</strong><br>`;
                data.personalized_recommendations.priority_actions.forEach(rec => {
                    content += `‚Ä¢ ${rec.description}<br>`;
                });
            }
            
            if (data.remediation && data.remediation.length > 0) {
                content += `<br><strong>‚ö†Ô∏è Remediation Needed:</strong><br>`;
                content += `Review these concepts: ${data.remediation.join(', ')}`;
            }
            
            return content;
        }

        function showDetailedProgress() {
            const progressMessage = `
                <strong>üìä Your Detailed Progress Report</strong><br><br>
                
                <strong>Overall Statistics:</strong><br>
                ‚Ä¢ Total Questions: ${progressData.overall_stats?.total_questions || 0}<br>
                ‚Ä¢ Overall Accuracy: ${progressData.overall_stats?.overall_accuracy || '0%'}<br>
                ‚Ä¢ Study Time: ${progressData.overall_stats?.total_time_hours || '0h'}<br>
                ‚Ä¢ Topics Attempted: ${progressData.overall_stats?.topics_attempted || 0}<br><br>
                
                <strong>Topic Progress:</strong><br>
                ${Object.entries(progressData.topic_progress || {}).map(([topic, data]) => 
                    `‚Ä¢ ${topic.replace('_', ' ').toUpperCase()}: ${(data.mastery_level * 100).toFixed(1)}% mastery (${data.total_attempts} attempts)`
                ).join('<br>')}<br><br>
                
                <strong>Recent Activity:</strong><br>
                ${(progressData.recent_activity || []).slice(0, 5).map(activity => 
                    `‚Ä¢ ${activity.topic} - ${activity.success ? '‚úÖ' : '‚ùå'} (${activity.timestamp})`
                ).join('<br>')}
            `;
            
            addMessage('assistant', progressMessage);
        }

        function toggleAnalytics() {
            const panel = analyticsPanel;
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                analyticsToggle.textContent = 'View Detailed Analytics';
            } else {
                loadAnalytics();
                panel.classList.add('active');
                analyticsToggle.textContent = 'Hide Analytics';
            }
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/student/analytics?days=30');
                const data = await response.json();
                
                analyticsPanel.innerHTML = `
                    <div class="chart-container">
                        <div class="chart-title">üìà Daily Performance (Last 30 Days)</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            ${data.daily_trend?.length || 0} active learning days
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">‚ö° Performance by Difficulty</div>
                        ${(data.difficulty_breakdown || []).map(item => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span style="font-size: 0.8rem;">Level ${item.difficulty_level}</span>
                                <span style="font-size: 0.8rem; font-weight: 500;">${(item.success_rate * 100).toFixed(1)}%</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">üïê Best Learning Hours</div>
                        ${(data.hourly_patterns || []).map(item => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span style="font-size: 0.8rem;">${item.hour}:00</span>
                                <span style="font-size: 0.8rem; font-weight: 500;">${(item.accuracy * 100).toFixed(1)}%</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                analyticsPanel.innerHTML = '<div style="color: var(--danger-color); font-size: 0.8rem;">Error loading analytics</div>';
            }
        }

        function resetSelections() {
            boardSelect.value = '';
            gradeSelect.value = '';
            languageSelect.value = 'english';
            currentState.board = null;
            currentState.grade = null;
            currentState.subtopic = null;
            currentState.methodPreference = null;
            currentState.excludeMethods = [];
            selectedGradeBadge.style.display = 'none';
            selectedBoardBadge.style.display = 'none';
            selectedSubtopicBadge.style.display = 'none';
            userInput.disabled = true;
            sendBtn.disabled = true;
            learningPathBtn.style.display = 'none';
            sessionInfo.style.display = 'none';
            
            // End any active session
            endLearningSession();
        }

        // Help command handling
        userInput.addEventListener('input', function(e) {
            if (this.value.toLowerCase() === 'help') {
                const helpText = `
                <strong>üöÄ Enhanced Learning Commands:</strong><br><br>
                
                <strong>Basic Commands:</strong><br>
                ‚Ä¢ "practice" - Get practice problems<br>
                ‚Ä¢ "explain [concept]" - Get detailed explanation<br>
                ‚Ä¢ "example" - See worked examples<br>
                ‚Ä¢ "quiz me" - Test your knowledge<br>
                ‚Ä¢ "summary" - Get topic summary<br><br>
                
                <strong>Progress Commands:</strong><br>
                ‚Ä¢ "progress" - View your progress<br>
                ‚Ä¢ "recommendations" - Get learning recommendations<br>
                ‚Ä¢ "analytics" - View performance analytics<br>
                ‚Ä¢ "mastery" - Check topic mastery levels<br><br>
                
                <strong>Adaptive Features:</strong><br>
                ‚Ä¢ Switch to "Adaptive Mode" for personalized content<br>
                ‚Ä¢ Use "Practice Mode" for focused problem solving<br>
                ‚Ä¢ Try "Review Mode" for concept revision<br><br>
                
                <strong>Progress Tracking:</strong><br>
                ‚Ä¢ All your interactions are automatically tracked<br>
                ‚Ä¢ Give feedback with üëç/üëé buttons to improve recommendations<br>
                ‚Ä¢ View real-time mastery levels in the progress panel
                `;
                addMessage('assistant', helpText);
                this.value = '';
            }
        });

        // Auto-save progress when user leaves
        window.addEventListener('beforeunload', function() {
            endLearningSession();
        });

        // Load initial progress data when page loads
        setTimeout(loadProgressData, 1000);
    </script>
</body>
</html>